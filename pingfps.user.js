// ==UserScript==
// @name         Survev.io Counters
// @namespace    http://tampermonkey.net/
// @license      MIT
// @version      4.0.0
// @description  Give survev.io better experience
// @author       asultra
// @match        https://survev.io/
// @icon         https://images-ext-1.discordapp.net/external/gTz23R2UY6gWx4qaPvrRMFXecuHz3bSyf7S5BDaGM-I/https/i.ibb.co/tp2807PV/image-png-4.png
// @grant        none
// ==/UserScript==
 
!function(){"use strict";const e=document.createElement("div");e.style.cssText="position: absolute; left: 10px; top: 40%; display: flex; flex-direction: column; gap: 5px; z-index: 10000; pointer-events: none;",document.body.appendChild(e);const t=t=>{const n=document.createElement("div");return n.style.cssText="color:white;font-size:14px;font-family:'roboto condensed', sans-serif;font-weight:bold;background-color:rgba(0,0,0,0.3);padding:3px 5px;border-radius:5px;white-space:nowrap;width:fit-content;line-height:1.2;",n.innerHTML=t,e.appendChild(n),n},n=t("0FPS | 0.1% 0FPS | 0ms"),s=t("0ms | ↑0% | lerp 0ms"),o=t(""),i=t("in: 0B | 0.0kbps | 0.0pps<br>out: 0.0kbps | 0.0pps"),l=t("server: 0Hz | missed 0%"),r=document.createElement("canvas");r.width=150,r.height=40,o.appendChild(r);const a=r.getContext("2d");let d,c,p,u,h,m=[],f=[],y=[],b=[],g=new Array(50).fill(0),w=0,x=[],k=0,v={in:{bytes:[],lastTime:0,pps:"0.0",lastSizeStr:"0B",kbps:"0.0"},out:{bytes:[],lastTime:0,pps:"0.0",kbps:"0.0"}},T=0,E=0;const L=(e,t)=>{const n=x.reduce((e,t)=>e+t,0)/(x.length||1),o=e-n,i=o>=0?`↑${Math.abs(o/n*100).toFixed(0)}%`:`↓${Math.abs(o/n*100).toFixed(0)}%`;s.style.color=e>=120?"red":e>=90?"orange":e>=60?"yellow":"white",s.innerHTML=`${e}ms | ${i} | lerp ${t}ms`},M=()=>{c&&(c.close(),c=null),clearTimeout(h),s.innerHTML="0ms | ↑0% | lerp 0ms",s.style.color="white",l.innerHTML="server: 0Hz | missed 0%",i.innerHTML="in: 0B | 0.0kbps | 0.0pps<br>out: 0.0kbps | 0.0pps",g.fill(0),a.clearRect(0,0,r.width,r.height),v.in.bytes=[],v.out.bytes=[],y=[],b=[],T=0,E=0,k=0},$=()=>{i.innerHTML=`in: ${v.in.lastSizeStr} | ${v.in.kbps} kbps | ${v.in.pps} pps<br>out: ${v.out.kbps} kbps | ${v.out.pps} pps`},S=window.WebSocket;function F(){c&&c.close(),g.fill(0),c=new S(`wss://${{na:"usr",eu:"eur",asia:"asr",sa:"sa",ru:"russia"}[d]}.mathsiscoolfun.com:8001/ptc`),c.onopen=()=>{clearTimeout(h),B()},c.onmessage=()=>{u=Date.now();const e=u-p;x.push(e),x.length>15&&x.shift(),g.push(Math.abs(e-w)),g.shift(),a.clearRect(0,0,r.width,r.height),a.beginPath(),a.strokeStyle="#00ff00",g.forEach((e,t)=>{const n=t/49*r.width,s=r.height-Math.min(e,40)/40*r.height;0===t?a.moveTo(n,s):a.lineTo(n,s)}),a.stroke(),w=e,L(w,E),setTimeout(B,500)},c.onclose=e=>{1005===e.code?M():1006===e.code&&(c=null,h=setTimeout(F,2500))}}function B(){1===c?.readyState&&(p=Date.now(),c.send(new ArrayBuffer(1)))}window.WebSocket=function(e,t){const n=new S(e,t);if(!e.includes("ptc")){n.addEventListener("message",e=>{const t=performance.now(),n=Date.now();if(T>0){const e=t-T;E=Math.round(e),L(w,E),v.in.pps=(1e3/e).toFixed(1),e>1e3/(y.length||30)*1.5&&b.push(n)}T=t,y.push(n);let s=e.data instanceof ArrayBuffer?e.data.byteLength:e.data.size||0;v.in.lastSizeStr=s>=1024?(s/1024).toFixed(1)+" KB":s+" B",v.in.bytes.push({t:n,v:s}),$()});const e=n.send;n.send=function(t){const n=performance.now();v.out.lastTime>0&&(v.out.pps=(1e3/(n-v.out.lastTime)).toFixed(1)),v.out.lastTime=n;const s=t.byteLength||t.size||0;return v.out.bytes.push({t:Date.now(),v:s}),$(),e.apply(this,arguments)}}return n},window.WebSocket.prototype=S.prototype;const H=()=>{window.requestAnimationFrame(()=>{const e=performance.now(),t=m.length>0?(e-m[m.length-1]).toFixed(1):0;for(;m.length>0&&m[0]<=e-1e3;)m.shift();m.push(e);const s=m.length;s>k&&(k=s),f.push(s),f.length>300&&f.shift(),n.style.color=k>0&&s<.85*k?"red":"white",n.innerHTML=`${s}FPS | 0.1% ${[...f].sort((e,t)=>e-t)[0]||0}FPS | ${t}ms`,H()})};H(),setInterval(()=>{const e=Date.now(),t=t=>{for(;t.length>0&&e-t[0].t>1e3;)t.shift();return(8*t.reduce((e,t)=>e+t.v,0)/1e3).toFixed(1)};if(c){for(v.in.kbps=t(v.in.bytes),v.out.kbps=t(v.out.bytes);y.length>0&&e-y[0]>1e3;)y.shift();for(;b.length>0&&e-b[0]>1e3;)b.shift();const n=y.length,s=b.length,o=n>0?(s/n*100).toFixed(0):0;l.innerHTML=`server: ${n}Hz | missed ${o}%`,l.style.color=n<20||o>5?"red":"white",$()}},500),window.addEventListener("load",()=>{const e=document.getElementsByClassName("btn-green btn-darken menu-option"),t=()=>{d=document.getElementById("server-select-main").value,F()};if(e.length>=4){for(let n=0;n<3;n++)e[n].onclick=t;e[3].onclick=()=>{d=document.getElementById("team-server-select").value,F()}}["btn-game-quit","btn-spectate-quit"].forEach(e=>{const t=document.getElementById(e);t&&(t.onclick=M)});const n=document.getElementById("ui-stats-options");n&&new MutationObserver(e=>{if(e[0].addedNodes.length>0){const e=n.getElementsByTagName("a")[0];e&&(e.onclick=M)}}).observe(n,{childList:!0})});var z=-1,C=-1,I=!1;const q=e=>`display:none;position:fixed;z-index:10000;top:50%;transform:translateY(-50%);mix-blend-mode:difference;font-weight:bold;font-size:large;pointer-events:none;-webkit-text-stroke:0.25px;${e}`,D=document.body.appendChild(document.createElement("span")),P=document.body.appendChild(document.createElement("span")),A=document.createElement("span"),N=document.createElement("span");D.style=q("left:calc(50% + 100vw/30);color:#ff4d4d;text-align:left;"),P.style=q("right:calc(50% + 100vw/30);color:#ff9800;text-align:right;"),A.style=N.style="display:block;position:fixed;z-index:2;margin:6px 0 0 0;mix-blend-mode:difference;font-weight:bold;font-size:large;",A.style.right=N.style.left="15px";const W=document.querySelector("#ui-health-container");W&&W.append(A,N),window.addEventListener("keydown",e=>{"o"===e.key.toLowerCase()&&(I=!I)}),setInterval(()=>{let e=document.getElementById("ui-health-actual"),t=e?.style.width.slice(0,-1);if(t&&e.offsetWidth>0){D.style.display=P.style.display=I?"block":"none",A.style.display=N.style.display=I?"none":"block";let e=e=>{let t=document.getElementById(`ui-boost-counter-${e}`);return t?parseFloat(t.querySelector(".ui-bar-inner").style.width.slice(0,-1)||0):0},n=(.25*(e(0)+e(1))+.375*e(2)+.125*e(3)).toFixed(1);z===t&&C===n||(z=t,C=n,A.innerHTML=D.innerHTML=Number(t).toFixed(1),N.innerHTML=P.innerHTML=n)}else D.style.display=P.style.display=A.style.display=N.style.display="none"},20)}();